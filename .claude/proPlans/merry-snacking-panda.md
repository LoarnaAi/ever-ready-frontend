# Implementation Plan: Migrate Job URLs from UUID to display_job_id

## Overview

Change the routing for job-detail and job-summary pages from using the internal UUID `job_id` to the human-readable `display_job_id` (format: `BUSREF-00001`, e.g., `LIMO-00001`).

**User Requirement:** Clean break - old UUID-based URLs will no longer work.

## Current vs Target State

**Current URL Structure:**
- Job Summary: `/[business]/home-removal/job-summary/[job_id]` (UUID)
- Job Detail: `/[business]/home-removal/job-detail/[job_id]` (UUID)
- Example: `/limo/home-removal/job-summary/d49c3ab4-1045-4a5a-90fe-23c7c5f17afb`

**Target URL Structure:**
- Job Summary: `/[business]/home-removal/job-summary/[display_job_id]`
- Job Detail: `/[business]/home-removal/job-detail/[display_job_id]`
- Example: `/limo/home-removal/job-summary/LIMO-00001`

## Database Schema (Reference)

```sql
create table jobs (
  job_id uuid primary key default gen_random_uuid(),
  display_job_id varchar(15) unique,  -- Format: BUSREF-NNNNN
  ...
)
```

The `display_job_id` is auto-generated by a database trigger based on `bus_ref` and a sequence number.

## Implementation Steps

### Step 1: Rename Route Directories

**Files to rename:**
1. `/src/app/[business]/home-removal/job-detail/[job_id]/` → `/src/app/[business]/home-removal/job-detail/[display_job_id]/`
2. `/src/app/[business]/home-removal/job-summary/[job_id]/` → `/src/app/[business]/home-removal/job-summary/[display_job_id]/`

**Impact:** After renaming, `params.job_id` becomes `params.display_job_id` in both pages.

### Step 2: Update Server Actions

**File:** `/src/lib/actions/jobActions.ts`

#### Change 1: Modify `getJobAction()` (lines 212-221)

**Current:**
```typescript
export async function getJobAction(
  jobId: string
): Promise<{ success: boolean; data?: JobData; error?: string }> {
  const { data: job, error: jobError } = await supabase
    .from("jobs")
    .select("*")
    .eq("job_id", jobId)  // Query by UUID
    .single();
  // ...
}
```

**New:**
```typescript
export async function getJobAction(
  displayJobId: string
): Promise<{ success: boolean; data?: JobData; error?: string }> {
  const { data: job, error: jobError } = await supabase
    .from("jobs")
    .select("*")
    .eq("display_job_id", displayJobId)  // Query by display_job_id
    .single();
  // ...
}
```

#### Change 2: Modify `updateJobStatusAction()` (lines 324-332)

**Current:**
```typescript
export async function updateJobStatusAction(
  jobId: string,
  status: JobStatus
): Promise<{ success: boolean; error?: string }> {
  const { error } = await supabase
    .from("jobs")
    .update({ status })
    .eq("job_id", jobId);  // Update by UUID
  // ...
}
```

**New:**
```typescript
export async function updateJobStatusAction(
  displayJobId: string,
  status: JobStatus
): Promise<{ success: boolean; error?: string }> {
  const { error } = await supabase
    .from("jobs")
    .update({ status })
    .eq("display_job_id", displayJobId);  // Update by display_job_id
  // ...
}
```

#### Change 3: Modify `updateInternalNotesAction()` (lines 348-356)

**Current:**
```typescript
export async function updateInternalNotesAction(
  jobId: string,
  notes: string
): Promise<{ success: boolean; error?: string }> {
  const { error } = await supabase
    .from("jobs")
    .update({ internal_notes: notes })
    .eq("job_id", jobId);  // Update by UUID
  // ...
}
```

**New:**
```typescript
export async function updateInternalNotesAction(
  displayJobId: string,
  notes: string
): Promise<{ success: boolean; error?: string }> {
  const { error } = await supabase
    .from("jobs")
    .update({ internal_notes: notes })
    .eq("display_job_id", displayJobId);  // Update by display_job_id
  // ...
}
```

### Step 3: Update Job Detail Page

**File:** `/src/app/[business]/home-removal/job-detail/[display_job_id]/page.tsx`

**Changes:**

1. **Line 19** - Update parameter extraction:
```typescript
// OLD:
const jobId = params.job_id as string;

// NEW:
const displayJobId = params.display_job_id as string;
```

2. **Line 34** - Update getJobAction call:
```typescript
// OLD:
const result = await getJobAction(jobId);

// NEW:
const result = await getJobAction(displayJobId);
```

3. **Line 44** - Update dependency array:
```typescript
// OLD:
}, [jobId]);

// NEW:
}, [displayJobId]);
```

4. **Line 48** - Update updateJobStatusAction call:
```typescript
// OLD:
const result = await updateJobStatusAction(jobId, newStatus);

// NEW:
const result = await updateJobStatusAction(displayJobId, newStatus);
```

5. **Line 57** - Update updateInternalNotesAction call:
```typescript
// OLD:
const result = await updateInternalNotesAction(jobId, notes);

// NEW:
const result = await updateInternalNotesAction(displayJobId, notes);
```

6. **Line 487** - Update link to job-summary:
```typescript
// OLD:
href={`/${businessSlug}/home-removal/job-summary/${jobId}`}

// NEW:
href={`/${businessSlug}/home-removal/job-summary/${job.display_job_id}`}
```

**Note:** The last change uses `job.display_job_id` from the fetched job data, not the URL parameter, since it's coming from the database and we want to ensure consistency.

### Step 4: Update Job Summary Page

**File:** `/src/app/[business]/home-removal/job-summary/[display_job_id]/page.tsx`

**Changes:**

1. **Line 15** - Update parameter extraction:
```typescript
// OLD:
const jobId = params.job_id as string;

// NEW:
const displayJobId = params.display_job_id as string;
```

2. **Line 29** - Update getJobAction call:
```typescript
// OLD:
const result = await getJobAction(jobId);

// NEW:
const result = await getJobAction(displayJobId);
```

3. **Line 39** - Update dependency array:
```typescript
// OLD:
}, [jobId]);

// NEW:
}, [displayJobId]);
```

### Step 5: Update Navigation in Home Removal Page

**File:** `/src/app/[business]/home-removal/page.tsx`

**Change at Line 401** - Update router.push to use display_job_id:

**Current:**
```typescript
const handleViewSummary = () => {
  router.push(`/${businessSlug}/home-removal/job-summary/${submittedJobId}`);
};
```

**New:**
```typescript
const handleViewSummary = () => {
  router.push(`/${businessSlug}/home-removal/job-summary/${displayJobId}`);
};
```

**Note:** The state variable `displayJobId` is already being set at line 357 from the job creation result, so we just need to use it here.

### Step 6: Update ConfirmationModal Component

**File:** `/src/components/ConfirmationModal.tsx`

**No changes required.** The component already receives both `jobId` and `displayJobId` as props (lines 12-13). The parent component (`home-removal/page.tsx`) handles all navigation via the `onViewSummary` callback, which we're updating in Step 5.

## Critical Files Summary

| File | Changes Required | Lines to Modify |
|------|------------------|----------------|
| `/src/lib/actions/jobActions.ts` | Change 3 functions to query/update by `display_job_id` | 212-221, 324-332, 348-356 |
| `/src/app/[business]/home-removal/job-detail/[display_job_id]/page.tsx` | Rename folder, update params, update all action calls | 19, 34, 44, 48, 57, 487 |
| `/src/app/[business]/home-removal/job-summary/[display_job_id]/page.tsx` | Rename folder, update params, update action call | 15, 29, 39 |
| `/src/app/[business]/home-removal/page.tsx` | Update navigation to use `displayJobId` | 401 |
| `/src/components/ConfirmationModal.tsx` | No changes required | - |

## Validation Strategy

Since we're doing a clean break, we should add validation to ensure the `display_job_id` format is valid:

**Validation Function (to add to jobActions.ts):**
```typescript
function isValidDisplayJobId(id: string): boolean {
  // Format: XXXX-NNNNN (4 uppercase letters, hyphen, 5 digits)
  return /^[A-Z]{4}-\d{5}$/.test(id);
}
```

**Where to use:**
- In page components before calling `getJobAction()` to provide better error messages
- Optionally in `getJobAction()` itself for server-side validation

## Error Handling

**Invalid format (e.g., malformed display_job_id):**
- The database query will return no results
- The "Job Not Found" error screen will be displayed (already exists in both pages at lines 132-154)

**Valid format but non-existent job:**
- Same behavior as above
- The existing error handling is sufficient

**Old UUID URLs:**
- Will be treated as invalid format
- Will show "Job Not Found" error screen
- No special handling required per user's clean break requirement

## Testing Checklist

After implementation, verify:

- [ ] Navigate to job-summary with display_job_id works (e.g., `/limo/home-removal/job-summary/LIMO-00001`)
- [ ] Navigate to job-detail with display_job_id works (e.g., `/limo/home-removal/job-detail/LIMO-00001`)
- [ ] Create new job and verify ConfirmationModal navigates to display_job_id URL
- [ ] Click "View Booking Summary" button in ConfirmationModal navigates correctly
- [ ] Update job status from job-detail page works
- [ ] Update internal notes from job-detail page works
- [ ] Click "Open Customer View" link from job-detail page works
- [ ] Old UUID URLs show "Job Not Found" error (expected behavior)
- [ ] Invalid display_job_id format shows "Job Not Found" error
- [ ] Non-existent display_job_id shows "Job Not Found" error
- [ ] Verify database queries use `display_job_id` column (check Supabase logs if needed)

## Edge Cases & Considerations

**Jobs without display_job_id:**
- The database trigger should ensure all new jobs have a `display_job_id`
- Existing jobs should already have this field populated
- If any old jobs don't have `display_job_id`, they will only be accessible via direct database queries (not via the UI)
- Consider running a database check: `SELECT COUNT(*) FROM jobs WHERE display_job_id IS NULL;`

**Case sensitivity:**
- Database column is varchar(15)
- Format is always uppercase (enforced by database trigger)
- URL matching is case-sensitive in Next.js
- No special handling needed

**URL sharing:**
- New URLs are more human-readable and easier to communicate
- Example: "Your booking reference is LIMO-00001, visit err.ever-ready.ai/limo/home-removal/job-summary/LIMO-00001"

**SEO implications:**
- New URLs are more descriptive and SEO-friendly
- No canonical URL changes needed since these are dynamic pages

## Implementation Order

1. **Update jobActions.ts** - Make database query changes first so functions accept `display_job_id`
2. **Rename route directories** - Use file system or IDE to rename both `[job_id]` folders to `[display_job_id]`
3. **Update job-detail page** - All parameter references and function calls
4. **Update job-summary page** - All parameter references and function calls
5. **Update home-removal page navigation** - Change router.push to use displayJobId
6. **Test thoroughly** - Run through entire booking flow and all page interactions
7. **Deploy** - The change is atomic and requires no migration or feature flag

## Risks & Mitigation

**Low Risk:**
- Navigation changes are straightforward
- State variables already exist for both IDs
- Database column already exists and is populated

**Medium Risk:**
- Directory renaming must be done carefully to avoid breaking routes
- All references to the old parameter name must be updated

**High Risk:**
- None identified - this is a clean implementation with no backward compatibility concerns

**Mitigation:**
- Test locally first with all user flows
- Verify database queries work correctly
- Check that all CRUD operations (read, update status, update notes) function properly

## Database Index Check

The `display_job_id` column has a UNIQUE constraint (per table schema), which creates an index automatically. This ensures query performance will be similar to UUID-based queries.

No additional database changes needed.

## Verification

After implementation, run these manual tests:

1. **Create a new job** - Verify the confirmation modal and subsequent navigation uses display_job_id
2. **View job summary** - Verify the page loads and displays correctly
3. **View job detail** - Verify the page loads with all data
4. **Update job status** - Verify status changes persist
5. **Update internal notes** - Verify notes changes persist
6. **Navigate between pages** - Click "Open Customer View" from job-detail
7. **Test error cases** - Try invalid display_job_id formats and non-existent IDs

## Final Notes

This is a clean implementation with minimal risk. The key insight is that all the infrastructure already exists:
- Database column is ready
- State variables are already in place
- Only routing and query parameters need updating

No database migrations, no backward compatibility code, no complex logic - just straightforward parameter renaming and query updates.
